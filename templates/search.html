<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .online { color: green; font-weight: bold; }
    .offline { color: gray; font-style: italic; }
    .logout-btn { margin-left: 20px; }
    .user-list-container { padding: 20px; }
    .top-bar { margin-bottom: 20px; }
    ul { list-style: none; padding-left: 0; }
    li { margin-bottom: 10px; }
    #search-input { margin-bottom: 10px; padding: 5px; width: 200px; }
  </style>
</head>
<body>
  <div class="user-list-container">
    <div class="top-bar">
      <span>üë§ {{ username }}</span>
      <a href="/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
    </div>

    <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
    <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫—É...">
    <ul id="users-list"></ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const username = "{{ username }}";
        const usersContainer = document.getElementById('users-list');
        const searchInput = document.getElementById('search-input');

        let allUsers = [];

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WS –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
        const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const wsStatus = new WebSocket(`${wsProtocol}://${location.host}/ws/status`);

        wsStatus.onmessage = (event) => {
            allUsers = JSON.parse(event.data);
            renderUsers();
        };

        wsStatus.onopen = () => console.log("Connected to status WS");
        wsStatus.onerror = (err) => console.error("WS error", err);

        function renderUsers() {
            usersContainer.innerHTML = '';
            const filterText = searchInput.value.toLowerCase();

            // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ—Ö –∫—Ä–æ–º–µ —Å–µ–±—è, —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫—É
            allUsers.forEach(u => {
                if(u.name === username) return;
                if(filterText && !u.name.toLowerCase().includes(filterText)) return;

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `/chat/${u.id}`;
                a.textContent = u.name + ' ';
                const span = document.createElement('span');
                span.textContent = u.online ? '‚óè online' : '‚óè offline';
                span.className = u.online ? 'online' : 'offline';
                a.appendChild(span);
                li.appendChild(a);
                usersContainer.appendChild(li);
            });
        }

        searchInput.addEventListener('input', renderUsers);
    });
  </script>
</body>
</html>
