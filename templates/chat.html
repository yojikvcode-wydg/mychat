<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ß–∞—Ç —Å {{ target_name }}</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="chat-container">
    <div class="top-bar">
      <a href="/index" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>
      <span>üí¨ {{ target_name }}</span>
    </div>
    <div id="messages"></div>
    <div class="composer">
      <input id="input" autocomplete="off" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <script>
    const userId = document.cookie.split('; ').find(r => r.startsWith('user_id=')).split('=')[1];
    const targetId = "{{ target_id }}";
    const ws = new WebSocket(`ws://${location.host}/ws/${userId}/${targetId}`);

    const messages = document.getElementById('messages');
    const input = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');

    async function loadHistory() {
      const res = await fetch(`/history/${userId}/${targetId}`);
      const data = await res.json();
      data.forEach(addMessage);
    }

    function addMessage(msg) {
      const div = document.createElement('div');
      div.classList.add('message');
      div.innerHTML = `<b>${msg.user}</b> [${msg.time}]: ${msg.text}`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    ws.onmessage = (event) => {
      addMessage(JSON.parse(event.data));
    };

    sendBtn.onclick = () => {
      if (input.value.trim() !== '') {
        ws.send(input.value);
        input.value = '';
      }
    };

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    loadHistory();
  </script>
</body>
</html>
